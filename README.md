# MongoDB Incremental & Full Backup System

A two-part Node.js system for backing up MongoDB data:

- `server/` (Backup Source): runs on the MongoDB host. Creates incremental backups from the oplog, compresses them with AES-256, and uploads them to the backup server.
- `client/` (Backup Server): runs as an HTTP service. Issues per-file passwords, receives uploads (incremental and chunked full), verifies checksums, tracks metadata in MongoDB, and stores files on disk.

---

## Contents
- Overview
- Architecture & Flow
- Requirements
- Installation
- Configuration (.env)
- Running (Source and Backup Server)
- Directory Layout
- APIs (Backup Server)
- Operational Notes
- Troubleshooting

---

## Overview
- Incremental backups are generated by streaming MongoDB oplog entries since the last saved timestamp into newline-delimited JSON (`.jsonl`).
- Each incremental file is zipped using 7-Zip with AES-256 encryption and a per-file password retrieved from the backup server.
- The compressed file and its checksum are uploaded to the backup server, which verifies integrity, records metadata, and stores files.
- Full backups are supported via chunked upload to handle large files.

---

## Architecture & Flow

### Incremental (Source → Backup Server)
1. `server/backup.js` reads from MongoDB `local.oplog.rs`, writes entries to a temp file, then renames it into `incrementals/` with a metadata-rich filename.
2. `server/upload.js` reads unsynced files, requests a password per file from the backup server (`/password/generate`), compresses with 7-Zip AES-256, computes checksum, uploads to `/upload`, and moves successfully uploaded files to `synced/`.

### Backup Server (Receiver)
- `client/index.js` starts an Express app with API key auth.
- `client/upload.js` handles:
  - `POST /upload` for incremental zip uploads (verifies checksum, stores file, updates DB record).
  - `POST /upload_full` for chunked full uploads (verifies each chunk checksum, appends, tracks final checksum).
- `client/password.js` handles per-file password generation/retrieval and stores encrypted password in MongoDB via `client/model.js`.

---

## Requirements
- Node.js 18+
- pnpm (recommended) or npm/yarn
- MongoDB (for both oplog on the source and metadata DB on the backup server)
- 7-Zip CLI on the source host (for compression): `7z` available in PATH

---

## Installation

From repository root, install dependencies for both apps:

```bash
cd server && pnpm install
cd ../client && pnpm install
```

---

## Configuration (.env)
Create `.env` files per app. Below are the environment variables that each side reads. Values in parentheses are defaults when applicable.

### server/.env (Backup Source)
- `MONGO_HOST` (localhost)
- `MONGO_PORT` (27017)
- `TARGET_BACKUP_SERVER` (e.g., http://backup-server:54322)
- `TARGET_BACKUP_APIKEY` (required) — API key expected by backup server
- `HASH_ALGORITM` (sha256) — checksum algorithm used when uploading
- `TEMP_FOLDER` (./temp) — temp directory for building oplog files
- `COMPRESSED_FOLDER` (./compressed) — where encrypted zips are written
- `ZIP_SIZE` (104857600) — size threshold in bytes to choose sync vs stream checksum for compressed files
- `LAST_OPLOG` (./last-oplog-ts.json) — where last processed oplog TS is saved
- `INCREMENTAL` (./incrementals) — new incremental files written here
- `SYNCED` (./synced) — moved here after successful upload
- `LOG_FOLDER` (./logs) — winston log output directory

### client/.env (Backup Server)
- `APIKEY` (required) — must match `TARGET_BACKUP_APIKEY` from server
- `CHECKSUM_SIZE_THRESHOLD_MB` (20) — for smart checksum strategy
- `APP_PORT` (54322) — Express server port
- `MONGODB_DB` (backup) — MongoDB database name for metadata
- `MONGODB_PORT` (27017)
- `MONGODB_HOST` (localhost)
- `UPLOAD_FOLDER` (./compressed)
- `COMPRESSED_DIR` (./compressed)
- `INCREMENTAL_DIR` (./incremental)
- `FULL_FOLDER` (./full) — stores assembled full backups
- `RESTORE` (false) — whether to auto-restore received files (if implemented)
- `RESTORED_FOLDER` (./restored)
- `LOG_FOLDER` (./logs)

---

## Running

### Start the Backup Server (Receiver)
```bash
cd client
pnpm start
```
- Starts Express on `APP_PORT`.
- Requires a running MongoDB per `client/config.js` to persist metadata (see `client/model.js`).

### Run Incremental Backup on Source
```bash
cd server
pnpm backup
```
- Executes `server/backup.js`, which generates one `.jsonl` incremental file in `INCREMENTAL` and updates `LAST_OPLOG`.

### Upload Pending Incrementals from Source
```bash
cd server
node upload.js
```
- For each file under `INCREMENTAL`:
  - Requests a per-file password: `POST /password/generate`
  - Compresses with 7-Zip AES-256 to `COMPRESSED_FOLDER`
  - Computes checksum and `POST /upload`
  - Moves original file to `SYNCED` if upload succeeds

Tip: Schedule `backup.js` and `upload.js` via OS scheduler (cron/systemd/Task Scheduler) for continuous operation.

---

## Directory Layout (Key Paths)

### server/
- `backup.js` — builds incremental oplog dumps as `.jsonl` (uses `mongodb.Timestamp`, `bson.EJSON`).
- `upload.js` — compresses and uploads incrementals.
- `config.js` — loads env and exports constants (API client, paths, logging, algos).
- `logger.js` — winston JSON logger writing to console and `logs/app.log`.
- `incrementals/` — newly created incremental files.
- `compressed/` — zipped encrypted files awaiting upload.
- `synced/` — originals moved here after successful upload.
- `temp/` — temp files and `last-oplog-ts.json`.

### client/
- `index.js` — Express app, auth middleware, JSON parsing, static serving.
- `upload.js` — multer storage; handlers for `/upload` and `/upload_full`; chunk append with checksum verification.
- `password.js` — per-file password generate/retrieve, uses `crypto.js` and `model.js`.
- `model.js` — Mongoose model for file metadata.
- `checksum.js` — adaptive checksum calc (sync vs stream).
- `config.js` — server config and paths.
- `logger.js` — winston JSON logger writing to console and `logs/app.log`.
- `full/`, `compressed/` — storage for received files.

---

## APIs (Backup Server)
All endpoints require header: `apikey: <APIKEY>`

### POST `/password/generate`
- Body: `{ "filename": "<name>.zip" }`
- Headers: `type: mongodb`
- Returns: plaintext password string for encrypting that zip file

### POST `/password/retrieve`
- Body: `{ "filename": "<name>.zip" }`
- Headers: `type: mongodb`
- Returns: plaintext password string for a previously saved file record

### POST `/upload` (Incremental Zip)
- Multipart form-data fields:
  - `file`: zip file stream
  - `checksum`: hex string
  - `filename`: zip filename
  - `algorithm`: checksum algorithm (e.g., `sha256`)
- Behavior: stores file under `COMPRESSED_DIR`, verifies checksum against uploaded content, updates MongoDB record (created beforehand when password was generated).
- Response: success message or 400 on checksum/name errors.

### POST `/upload_full` (Chunked Full Upload)
- Multipart form-data: `file` (chunk)
- Body fields: `chunkIndex`, `fileName`, `checksum`, `totalChunks`
- Headers: `algorithm` (e.g., `sha256`)
- Behavior: verifies chunk checksum, appends to final file under `FULL_FOLDER`, maintains incremental hash; on last chunk, logs final checksum.

---

## Operational Notes
- Logging: both apps write structured logs to console and `logs/app.log`.
- Filenames: incremental dumps follow `incremental-backup-<YYYY-MM-DD--H-mm-ss>-<t>-<i>-i<ins>-u<upd>-d<del>.jsonl`.
- Security: transport uses API key; payloads are encrypted-at-rest via AES-256 zipped with per-file password. Consider TLS at the reverse proxy.
- 7-Zip requirement: ensure `7z` CLI is installed and accessible on the source host.

---

## Troubleshooting
- Missing API key → 401 from backup server. Ensure `APIKEY` and `TARGET_BACKUP_APIKEY` match.
- Checksum failed on server → verify the same `algorithm` is used and that upload is not truncated.
- No oplog data → ensure MongoDB is a replica set with an oplog and the URI in `server/config.js` points to `local` db.
- Permission errors writing files → validate paths in env and process permissions.
- 7-Zip not found → ensure it is installed and `7z` is in PATH.

## References
- [GitHub Repository](https://github.com/hmbmirzaei/incremental)
- [LinkedIn Post](https://www.linkedin.com/posts/hossein-mirzaei-51562514a_github-hmbmirzaeiincremental-mongoincrementalbackup-activity-7376206668243628032-lTW7?utm_source=share&utm_medium=member_desktop&rcm=ACoAACQLLqEBCvOinVB6gOgOcfANqMtWOdLqlXE)
